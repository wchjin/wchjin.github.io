<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>项目部署docker篇 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="在上回提到的开发和部署过程中引入 Docker 技术，可以优化流程、提高一致性和可移植性。使用 Docker，可以将前端、后端和数据库打包成独立的容器，简化部署和管理。以下是详细的步骤指南，介绍如何使用 Docker 在 CentOS 系统上部署你的 Nuxt + Vue3 前端、NestJS 后端以及 MongoDB 数据库项目。 一、准备工作1. 服务器环境准备确保你拥有 CentOS 服务器">
<meta property="og:type" content="article">
<meta property="og:title" content="项目部署docker篇">
<meta property="og:url" content="http://example.com/2024/09/24/%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2docker%E7%AF%87/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="在上回提到的开发和部署过程中引入 Docker 技术，可以优化流程、提高一致性和可移植性。使用 Docker，可以将前端、后端和数据库打包成独立的容器，简化部署和管理。以下是详细的步骤指南，介绍如何使用 Docker 在 CentOS 系统上部署你的 Nuxt + Vue3 前端、NestJS 后端以及 MongoDB 数据库项目。 一、准备工作1. 服务器环境准备确保你拥有 CentOS 服务器">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-09-24T08:53:02.000Z">
<meta property="article:modified_time" content="2024-09-28T13:41:20.084Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="docker">
<meta property="article:tag" content="deploy">
<meta property="article:tag" content="centos">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-项目部署docker篇" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/09/24/%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2docker%E7%AF%87/" class="article-date">
  <time class="dt-published" datetime="2024-09-24T08:53:02.000Z" itemprop="datePublished">2024-09-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      项目部署docker篇
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>在上回提到的开发和部署过程中引入 Docker 技术，可以优化流程、提高一致性和可移植性。使用 Docker，可以将前端、后端和数据库打包成独立的容器，简化部署和管理。以下是详细的步骤指南，介绍如何使用 Docker 在 CentOS 系统上部署你的 Nuxt + Vue3 前端、NestJS 后端以及 MongoDB 数据库项目。</p>
<h2 id="一、准备工作"><a href="#一、准备工作" class="headerlink" title="一、准备工作"></a>一、准备工作</h2><h3 id="1-服务器环境准备"><a href="#1-服务器环境准备" class="headerlink" title="1. 服务器环境准备"></a>1. 服务器环境准备</h3><p>确保你拥有 CentOS 服务器的访问权限，并且可以通过 SSH 连接。</p>
<p>更新服务器软件包：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> yum update -y</span><br></pre></td></tr></table></figure>

<h3 id="2-安装-Docker-和-Docker-Compose"><a href="#2-安装-Docker-和-Docker-Compose" class="headerlink" title="2. 安装 Docker 和 Docker Compose"></a>2. 安装 Docker 和 Docker Compose</h3><h4 id="安装-Docker"><a href="#安装-Docker" class="headerlink" title="安装 Docker"></a>安装 Docker</h4><ol>
<li><p><strong>安装必要的依赖包</strong>：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> yum install -y yum-utils device-mapper-persistent-data lvm2</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>添加 Docker 仓库</strong>：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>安装 Docker Engine</strong>：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> yum install -y docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>启动并设置 Docker 开机自启</strong>：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl start docker</span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> docker</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>验证 Docker 安装</strong>：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker --version</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="安装-Docker-Compose"><a href="#安装-Docker-Compose" class="headerlink" title="安装 Docker Compose"></a>安装 Docker Compose</h4><ol>
<li><p><strong>下载 Docker Compose 二进制文件</strong>：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> curl -L <span class="string">&quot;https://github.com/docker/compose/releases/download/v2.20.2/docker-compose-<span class="subst">$(uname -s)</span>-<span class="subst">$(uname -m)</span>&quot;</span> -o /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong>：请根据 <a target="_blank" rel="noopener" href="https://github.com/docker/compose/releases">Docker Compose Releases</a> 页面检查最新版本号，并替换上面的版本号 <code>v2.20.2</code>。</p>
</blockquote>
</li>
<li><p><strong>赋予执行权限</strong>：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> +x /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>创建软链接（可选）</strong>：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">ln</span> -s /usr/local/bin/docker-compose /usr/bin/docker-compose</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>验证 Docker Compose 安装</strong>：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose --version</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="3-配置防火墙"><a href="#3-配置防火墙" class="headerlink" title="3. 配置防火墙"></a>3. 配置防火墙</h3><p>确保必要的端口（如80、443、22）开放：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> firewall-cmd --permanent --add-service=http</span><br><span class="line"><span class="built_in">sudo</span> firewall-cmd --permanent --add-service=https</span><br><span class="line"><span class="built_in">sudo</span> firewall-cmd --permanent --add-service=ssh</span><br><span class="line"><span class="built_in">sudo</span> firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<h2 id="二、项目结构调整"><a href="#二、项目结构调整" class="headerlink" title="二、项目结构调整"></a>二、项目结构调整</h2><p>为了使用 Docker 部署，建议调整项目结构，使前后端项目和数据库服务在不同的容器中运行。典型的项目结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">myproject/</span><br><span class="line">├── backend/</span><br><span class="line">│   ├── Dockerfile</span><br><span class="line">│   ├── package.json</span><br><span class="line">│   ├── tsconfig.json</span><br><span class="line">│   ├── src/</span><br><span class="line">│   └── ...（其他后端文件）</span><br><span class="line">├── frontend/</span><br><span class="line">│   ├── Dockerfile</span><br><span class="line">│   ├── package.json</span><br><span class="line">│   ├── nuxt.config.js</span><br><span class="line">│   └── ...（其他前端文件）</span><br><span class="line">├── docker-compose.yml</span><br><span class="line">└── nginx/</span><br><span class="line">    ├── Dockerfile</span><br><span class="line">    └── nginx.conf</span><br></pre></td></tr></table></figure>

<h3 id="1-创建项目目录"><a href="#1-创建项目目录" class="headerlink" title="1. 创建项目目录"></a>1. 创建项目目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /var/www/myproject</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span> $(<span class="built_in">whoami</span>):$(<span class="built_in">whoami</span>) /var/www/myproject</span><br><span class="line"><span class="built_in">cd</span> /var/www/myproject</span><br></pre></td></tr></table></figure>

<h3 id="2-克隆代码仓库"><a href="#2-克隆代码仓库" class="headerlink" title="2. 克隆代码仓库"></a>2. 克隆代码仓库</h3><p>假设前端和后端代码分别托管在不同的 Git 仓库中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 克隆前端项目</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/yourusername/your-frontend-repo.git frontend</span><br><span class="line"></span><br><span class="line"><span class="comment"># 克隆后端项目</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/yourusername/your-backend-repo.git backend</span><br></pre></td></tr></table></figure>

<h2 id="三、编写-Docker-配置文件"><a href="#三、编写-Docker-配置文件" class="headerlink" title="三、编写 Docker 配置文件"></a>三、编写 Docker 配置文件</h2><h3 id="1-后端（NestJS）Dockerfile"><a href="#1-后端（NestJS）Dockerfile" class="headerlink" title="1. 后端（NestJS）Dockerfile"></a>1. 后端（NestJS）Dockerfile</h3><p>在 <code>backend/</code> 目录下创建 <code>Dockerfile</code>：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># backend/Dockerfile</span></span><br><span class="line"><span class="keyword">FROM</span> node:<span class="number">18</span>-alpine</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置工作目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制 package.json 和 package-lock.json</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> package*.json ./</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm install</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制整个项目</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建应用</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm run build</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴露端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">3000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动应用</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;npm&quot;</span>, <span class="string">&quot;run&quot;</span>, <span class="string">&quot;start:prod&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h3 id="2-前端（Nuxt-Vue3）Dockerfile"><a href="#2-前端（Nuxt-Vue3）Dockerfile" class="headerlink" title="2. 前端（Nuxt + Vue3）Dockerfile"></a>2. 前端（Nuxt + Vue3）Dockerfile</h3><p>在 <code>frontend/</code> 目录下创建 <code>Dockerfile</code>：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frontend/Dockerfile</span></span><br><span class="line"><span class="keyword">FROM</span> node:<span class="number">18</span>-alpine as builder</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置工作目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制 package.json 和 package-lock.json</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> package*.json ./</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm install</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制整个项目</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建前端应用</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm run build</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 Nginx 作为静态资源服务器</span></span><br><span class="line"><span class="keyword">FROM</span> nginx:stable-alpine</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制构建产物到 Nginx 目录</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/.output/public /usr/share/nginx/html</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制自定义 Nginx 配置（可选）</span></span><br><span class="line"><span class="comment"># COPY nginx.conf /etc/nginx/nginx.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴露端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 Nginx</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;nginx&quot;</span>, <span class="string">&quot;-g&quot;</span>, <span class="string">&quot;daemon off;&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong>：根据 Nuxt 3 的输出配置，可能需要调整 <code>.output/public</code> 的路径。请参考 <a target="_blank" rel="noopener" href="https://v3.nuxtjs.org/docs/deployment/deployment-targets">Nuxt 3 部署文档</a> 确认构建产物路径。</p>
</blockquote>
<h3 id="3-Nginx-反向代理-Dockerfile（可选）"><a href="#3-Nginx-反向代理-Dockerfile（可选）" class="headerlink" title="3. Nginx 反向代理 Dockerfile（可选）"></a>3. Nginx 反向代理 Dockerfile（可选）</h3><p>为了将前端和后端通过 Nginx 进行统一代理，可以创建一个独立的 Nginx 服务。这里使用主机 Nginx 更为简单，因此此部分可选。</p>
<h3 id="4-Docker-Compose-配置"><a href="#4-Docker-Compose-配置" class="headerlink" title="4. Docker Compose 配置"></a>4. Docker Compose 配置</h3><p>在项目根目录 <code>/var/www/myproject</code> 下创建 <code>docker-compose.yml</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose.yml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mongodb:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mongo:6.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mongodb</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;27017:27017&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MONGO_INITDB_ROOT_USERNAME:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">MONGO_INITDB_ROOT_PASSWORD:</span> <span class="string">example</span></span><br><span class="line">      <span class="attr">MONGO_INITDB_DATABASE:</span> <span class="string">yourdbname</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mongo-data:/data/db</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">backend:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">./backend</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">backend</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3000:3000&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">PORT=3000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MONGO_URI=mongodb://root:example@mongodb:27017/yourdbname?authSource=admin</span></span><br><span class="line">      <span class="comment"># 其他环境变量</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mongodb</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">frontend:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">./frontend</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">NUXT_API_BASE_URL=/api</span></span><br><span class="line">      <span class="comment"># 其他环境变量</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">backend</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:stable-alpine</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:80&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;443:443&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx/nginx.conf:/etc/nginx/nginx.conf:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">certs:/etc/letsencrypt</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">certs-data:/var/lib/letsencrypt</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">frontend</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">backend</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">mongo-data:</span></span><br><span class="line">  <span class="attr">certs:</span></span><br><span class="line">  <span class="attr">certs-data:</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong>：</p>
<ul>
<li><code>nginx</code> 服务用于处理反向代理和 SSL（后续步骤会详细配置）。</li>
<li>如果选择使用主机 Nginx，可以省略 <code>nginx</code> 服务。</li>
</ul>
</blockquote>
<h3 id="5-Nginx-配置文件"><a href="#5-Nginx-配置文件" class="headerlink" title="5. Nginx 配置文件"></a>5. Nginx 配置文件</h3><p>在 <code>nginx/</code> 目录下创建 <code>nginx.conf</code>：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nginx/nginx.conf</span></span><br><span class="line"><span class="section">events</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span> yourdomain.com www.yourdomain.com;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 强制 HTTPS</span></span><br><span class="line">        <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">        <span class="attribute">server_name</span> yourdomain.com www.yourdomain.com;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">ssl_certificate</span> /etc/letsencrypt/live/yourdomain.com/fullchain.pem;</span><br><span class="line">        <span class="attribute">ssl_certificate_key</span> /etc/letsencrypt/live/yourdomain.com/privkey.pem;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">ssl_protocols</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;</span><br><span class="line">        <span class="attribute">ssl_ciphers</span> HIGH:!aNULL:!MD5;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 前端静态文件</span></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://frontend:80;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 后端 API 代理</span></span><br><span class="line">        <span class="section">location</span> /api/ &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://backend:3000/;</span><br><span class="line">            <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Connection <span class="string">&#x27;upgrade&#x27;</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">            <span class="attribute">proxy_cache_bypass</span> <span class="variable">$http_upgrade</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong>：</p>
<ul>
<li>替换 <code>yourdomain.com</code> 为你的实际域名。</li>
<li>SSL 证书路径与 Docker Compose 中的卷配置对应。</li>
</ul>
</blockquote>
<h2 id="四、配置环境变量"><a href="#四、配置环境变量" class="headerlink" title="四、配置环境变量"></a>四、配置环境变量</h2><h3 id="1-后端（NestJS）环境变量"><a href="#1-后端（NestJS）环境变量" class="headerlink" title="1. 后端（NestJS）环境变量"></a>1. 后端（NestJS）环境变量</h3><p>在 <code>backend/</code> 目录下创建 <code>.env</code> 文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># backend/.env</span><br><span class="line">PORT=3000</span><br><span class="line">MONGO_URI=mongodb://root:example@mongodb:27017/yourdbname?authSource=admin</span><br><span class="line"># 其他环境变量</span><br></pre></td></tr></table></figure>

<h3 id="2-前端（Nuxt-Vue3）环境变量"><a href="#2-前端（Nuxt-Vue3）环境变量" class="headerlink" title="2. 前端（Nuxt + Vue3）环境变量"></a>2. 前端（Nuxt + Vue3）环境变量</h3><p>在 <code>frontend/</code> 目录下创建 <code>.env</code> 或 <code>.env.production</code> 文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># frontend/.env</span><br><span class="line">NUXT_API_BASE_URL=/api</span><br><span class="line"># 其他环境变量</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong>：确保这些环境变量在构建前被正确加载。</p>
</blockquote>
<h2 id="五、使用-Docker-Compose-部署"><a href="#五、使用-Docker-Compose-部署" class="headerlink" title="五、使用 Docker Compose 部署"></a>五、使用 Docker Compose 部署</h2><h3 id="1-启动-Docker-Compose"><a href="#1-启动-Docker-Compose" class="headerlink" title="1. 启动 Docker Compose"></a>1. 启动 Docker Compose</h3><p>在项目根目录 <code>/var/www/myproject</code> 下运行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>此命令将构建并启动所有服务（前端、后端、MongoDB 和 Nginx）。</p>
<h3 id="2-查看容器状态"><a href="#2-查看容器状态" class="headerlink" title="2. 查看容器状态"></a>2. 查看容器状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose ps</span><br></pre></td></tr></table></figure>

<p>确保所有容器均在运行状态。</p>
<h3 id="3-配置-Docker-Compose-自动重启"><a href="#3-配置-Docker-Compose-自动重启" class="headerlink" title="3. 配置 Docker Compose 自动重启"></a>3. 配置 Docker Compose 自动重启</h3><p><code>docker-compose.yml</code> 中已经配置了 <code>restart: always</code>，确保服务在服务器重启后自动启动。</p>
<h2 id="六、配置-SSL-证书"><a href="#六、配置-SSL-证书" class="headerlink" title="六、配置 SSL 证书"></a>六、配置 SSL 证书</h2><p>为了启用 HTTPS，需要获取 SSL 证书。我们将使用 Let’s Encrypt 的 Certbot 工具。</p>
<h3 id="1-安装-Certbot"><a href="#1-安装-Certbot" class="headerlink" title="1. 安装 Certbot"></a>1. 安装 Certbot</h3><p>在 CentOS 上安装 Certbot：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> yum install -y epel-release</span><br><span class="line"><span class="built_in">sudo</span> yum install -y certbot</span><br></pre></td></tr></table></figure>

<h3 id="2-生成-SSL-证书"><a href="#2-生成-SSL-证书" class="headerlink" title="2. 生成 SSL 证书"></a>2. 生成 SSL 证书</h3><p>临时启动 Nginx 服务以完成域名的 DNS 验证。由于我们已经配置了 <code>nginx</code> 服务在 Docker Compose 中监听 80 端口，需要在获取证书前确保 Nginx 可以正确处理验证请求。</p>
<p>如果你使用 Docker 配置的 Nginx 管理 SSL，可以使用 Certbot 的 DNS 或单独配置证书。这里推荐使用 Certbot 的 <code>--nginx</code> 插件直接配置 SSL。</p>
<p>进入 <code>nginx</code> 服务并安装 Certbot：</p>
<p>由于 Nginx 在 Docker 容器中运行，直接在容器中使用 Certbot 可能较为复杂。更简单的方法是在主机上使用 Certbot，然后将证书挂载到 Nginx 容器中。</p>
<h4 id="方法一：在主机上获取证书"><a href="#方法一：在主机上获取证书" class="headerlink" title="方法一：在主机上获取证书"></a>方法一：在主机上获取证书</h4><ol>
<li><p><strong>暂时停止 Docker Compose 中的 Nginx 服务</strong>：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose stop nginx</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>使用 Certbot 获取证书</strong>：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> certbot certonly --standalone -d yourdomain.com -d www.yourdomain.com</span><br></pre></td></tr></table></figure>

<p> 按照提示完成认证过程。这将在主机上的 <code>/etc/letsencrypt/live/yourdomain.com/</code> 目录下生成 SSL 证书。</p>
</li>
<li><p><strong>启动 Docker Compose 中的 Nginx 服务</strong>：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose start nginx</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>确保 <code>docker-compose.yml</code> 中的 Nginx 配置正确挂载证书</strong>：</p>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:stable-alpine</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;443:443&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx/nginx.conf:/etc/nginx/nginx.conf:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/etc/letsencrypt:/etc/letsencrypt:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/var/lib/letsencrypt:/var/lib/letsencrypt:ro</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong>：确保主机上的 <code>/etc/letsencrypt</code> 目录已经包含 SSL 证书。</p>
</blockquote>
</li>
</ol>
<h4 id="方法二：在-Docker-中使用-Certbot"><a href="#方法二：在-Docker-中使用-Certbot" class="headerlink" title="方法二：在 Docker 中使用 Certbot"></a>方法二：在 Docker 中使用 Certbot</h4><ol>
<li><strong>在 Docker Compose 中添加 Certbot 服务</strong>（需要复杂的配置和自动化脚本，不在此详细展开）。此方法更为复杂，推荐方法一。</li>
</ol>
<h3 id="3-配置自动续期"><a href="#3-配置自动续期" class="headerlink" title="3. 配置自动续期"></a>3. 配置自动续期</h3><p>让 Certbot 定期续期 SSL 证书。Certbot 通常会自动添加续期任务，但你可以手动测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> certbot renew --dry-run</span><br></pre></td></tr></table></figure>

<p>若使用主机上的 Certbot，请确保挂载的 <code>/etc/letsencrypt</code> 目录保持最新，Nginx 容器可以访问最新证书。</p>
<h2 id="七、优化与安全"><a href="#七、优化与安全" class="headerlink" title="七、优化与安全"></a>七、优化与安全</h2><h3 id="1-数据持久化"><a href="#1-数据持久化" class="headerlink" title="1. 数据持久化"></a>1. 数据持久化</h3><p>确保 MongoDB 数据持久化，通过 Docker 卷挂载数据目录：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mongodb:</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mongo-data:/data/db</span></span><br></pre></td></tr></table></figure>

<h3 id="2-环境变量安全"><a href="#2-环境变量安全" class="headerlink" title="2. 环境变量安全"></a>2. 环境变量安全</h3><p>敏感信息（如数据库密码）应通过 <code>.env</code> 文件或 Docker secrets 进行管理，不应硬编码在 <code>docker-compose.yml</code> 中。</p>
<h3 id="3-网络配置"><a href="#3-网络配置" class="headerlink" title="3. 网络配置"></a>3. 网络配置</h3><p>默认情况下，Docker Compose 会为服务创建一个内部网络，服务间可以通过服务名称相互访问（如 <code>mongodb</code>、<code>backend</code>、<code>frontend</code>）。</p>
<h3 id="4-日志管理"><a href="#4-日志管理" class="headerlink" title="4. 日志管理"></a>4. 日志管理</h3><p>Docker Container 的日志可通过 <code>docker-compose logs</code> 查看，或者配置日志驱动将日志发送到集中式日志系统。</p>
<h3 id="5-防火墙和安全组"><a href="#5-防火墙和安全组" class="headerlink" title="5. 防火墙和安全组"></a>5. 防火墙和安全组</h3><p>确保防火墙只开放必要的端口（如 80、443、22），其他服务端口（如 27017、3000）仅对内部网络开放。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> firewall-cmd --permanent --add-service=http</span><br><span class="line"><span class="built_in">sudo</span> firewall-cmd --permanent --add-service=https</span><br><span class="line"><span class="built_in">sudo</span> firewall-cmd --permanent --add-service=ssh</span><br><span class="line"><span class="built_in">sudo</span> firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<h3 id="6-SELinux-配置"><a href="#6-SELinux-配置" class="headerlink" title="6. SELinux 配置"></a>6. SELinux 配置</h3><p>如果启用 SELinux，确保 Docker 有足够的权限访问挂载的卷和端口。</p>
<p>检查 SELinux 状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sestatus</span><br></pre></td></tr></table></figure>

<p>若需要，允许 HTTPD 连接网络：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> setsebool -P httpd_can_network_connect on</span><br></pre></td></tr></table></figure>

<h3 id="7-资源限制（可选）"><a href="#7-资源限制（可选）" class="headerlink" title="7. 资源限制（可选）"></a>7. 资源限制（可选）</h3><p>在 <code>docker-compose.yml</code> 中为各服务设置资源限制，防止单个容器占用过多资源：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">backend:</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">cpus:</span> <span class="string">&quot;1.0&quot;</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">&quot;512M&quot;</span></span><br><span class="line">  <span class="attr">frontend:</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">cpus:</span> <span class="string">&quot;0.5&quot;</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">&quot;256M&quot;</span></span><br><span class="line">  <span class="attr">mongodb:</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">cpus:</span> <span class="string">&quot;2.0&quot;</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">&quot;2G&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong>：<code>deploy</code> 配置在 Docker Swarm 中有效，对于单机 Docker Compose，可使用 <code>deploy</code> 的资源限制作为参考。</p>
</blockquote>
<h2 id="八、部署与测试"><a href="#八、部署与测试" class="headerlink" title="八、部署与测试"></a>八、部署与测试</h2><h3 id="1-构建并启动所有服务"><a href="#1-构建并启动所有服务" class="headerlink" title="1. 构建并启动所有服务"></a>1. 构建并启动所有服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d --build</span><br></pre></td></tr></table></figure>

<h3 id="2-查看服务日志"><a href="#2-查看服务日志" class="headerlink" title="2. 查看服务日志"></a>2. 查看服务日志</h3><p>确保所有服务正常启动：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose logs -f</span><br></pre></td></tr></table></figure>

<h3 id="3-访问应用"><a href="#3-访问应用" class="headerlink" title="3. 访问应用"></a>3. 访问应用</h3><ul>
<li><strong>前端</strong>：访问 <code>http://yourdomain.com</code> 或 <code>https://yourdomain.com</code>。</li>
<li><strong>后端 API</strong>：通过前端发起的请求（如 <code>https://yourdomain.com/api/...</code>）。</li>
</ul>
<h3 id="4-测试功能"><a href="#4-测试功能" class="headerlink" title="4. 测试功能"></a>4. 测试功能</h3><ul>
<li>确认前端页面正常加载。</li>
<li>确认前端能够成功调用后端 API。</li>
<li>确认后端能够正确连接 MongoDB 并操作数据库。</li>
</ul>
<h3 id="5-排查问题"><a href="#5-排查问题" class="headerlink" title="5. 排查问题"></a>5. 排查问题</h3><p>如遇问题，查看相关服务的日志：</p>
<ul>
<li><p><strong>Nginx</strong>：</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose logs -f nginx</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>前端</strong>：</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose logs -f frontend</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>后端</strong>：</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose logs -f backend</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>MongoDB</strong>：</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose logs -f mongodb</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="九、开发环境中的-Docker-使用"><a href="#九、开发环境中的-Docker-使用" class="headerlink" title="九、开发环境中的 Docker 使用"></a>九、开发环境中的 Docker 使用</h2><p>为了在开发环境中使用 Docker，确保开发代码能够被容器实时更新。可以通过挂载主机代码目录到容器中，并使用适合开发的命令（如 <code>npm run dev</code>）。</p>
<h3 id="示例：开发模式的-docker-compose-dev-yml"><a href="#示例：开发模式的-docker-compose-dev-yml" class="headerlink" title="示例：开发模式的 docker-compose.dev.yml"></a>示例：开发模式的 <code>docker-compose.dev.yml</code></h3><p>创建一个 <code>docker-compose.dev.yml</code> 文件用于开发环境：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose.dev.yml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mongodb:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mongo:6.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mongodb_dev</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;27017:27017&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MONGO_INITDB_ROOT_USERNAME:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">MONGO_INITDB_ROOT_PASSWORD:</span> <span class="string">example</span></span><br><span class="line">      <span class="attr">MONGO_INITDB_DATABASE:</span> <span class="string">yourdbname</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mongo-data-dev:/data/db</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">backend:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./backend</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile.dev</span> <span class="comment"># 为开发环境创建不同的 Dockerfile</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">backend_dev</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3000:3000&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">PORT=3000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MONGO_URI=mongodb://root:example@mongodb:27017/yourdbname?authSource=admin</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./backend:/app</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/app/node_modules</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">start:dev</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mongodb</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">frontend:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./frontend</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile.dev</span> <span class="comment"># 为开发环境创建不同的 Dockerfile</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">frontend_dev</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3001:3000&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">NUXT_API_BASE_URL=/api</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./frontend:/app</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/app/node_modules</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">dev</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">backend</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">mongo-data-dev:</span></span><br></pre></td></tr></table></figure>

<h3 id="创建开发环境的-Dockerfiles"><a href="#创建开发环境的-Dockerfiles" class="headerlink" title="创建开发环境的 Dockerfiles"></a>创建开发环境的 Dockerfiles</h3><h4 id="后端开发-Dockerfile-backend-Dockerfile-dev"><a href="#后端开发-Dockerfile-backend-Dockerfile-dev" class="headerlink" title="后端开发 Dockerfile (backend/Dockerfile.dev)"></a>后端开发 Dockerfile (<code>backend/Dockerfile.dev</code>)</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># backend/Dockerfile.dev</span></span><br><span class="line"><span class="keyword">FROM</span> node:<span class="number">18</span>-alpine</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> package*.json ./</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm install</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">3000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;npm&quot;</span>, <span class="string">&quot;run&quot;</span>, <span class="string">&quot;start:dev&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h4 id="前端开发-Dockerfile-frontend-Dockerfile-dev"><a href="#前端开发-Dockerfile-frontend-Dockerfile-dev" class="headerlink" title="前端开发 Dockerfile (frontend/Dockerfile.dev)"></a>前端开发 Dockerfile (<code>frontend/Dockerfile.dev</code>)</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frontend/Dockerfile.dev</span></span><br><span class="line"><span class="keyword">FROM</span> node:<span class="number">18</span>-alpine</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> package*.json ./</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm install</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">3000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;npm&quot;</span>, <span class="string">&quot;run&quot;</span>, <span class="string">&quot;dev&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h3 id="启动开发环境"><a href="#启动开发环境" class="headerlink" title="启动开发环境"></a>启动开发环境</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose -f docker-compose.dev.yml up -d --build</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong>：前端开发服务映射到主机的 <code>3001</code> 端口，避免与生产环境的 <code>80</code> 端口冲突。</p>
</blockquote>
<h2 id="十、总结"><a href="#十、总结" class="headerlink" title="十、总结"></a>十、总结</h2><p>通过引入 Docker 技术，可以显著优化开发和部署流程，实现以下优势：</p>
<ol>
<li><strong>环境一致性</strong>：确保开发、测试和生产环境的一致性，减少“在我机器上可以运行”的问题。</li>
<li><strong>简化部署</strong>：使用 Docker Compose 可以一键启动所有服务，简化部署步骤。</li>
<li><strong>隔离性</strong>：各服务在独立的容器中运行，避免依赖冲突和环境污染。</li>
<li><strong>可扩展性</strong>：方便水平扩展服务，如增加后端实例以提升性能。</li>
<li><strong>便捷的版本控制</strong>：通过 Docker 镜像版本控制，轻松回滚到之前的稳定版本。</li>
</ol>
<h3 id="关键步骤回顾："><a href="#关键步骤回顾：" class="headerlink" title="关键步骤回顾："></a>关键步骤回顾：</h3><ol>
<li><strong>安装 Docker 和 Docker Compose</strong>：在 CentOS 上安装并配置好 Docker 环境。</li>
<li><strong>项目结构调整</strong>：确保前后端项目具备 Docker 配置文件，统一管理。</li>
<li><strong>编写 Docker 配置文件</strong>：为前后端和数据库编写 Dockerfile，配置 Docker Compose。</li>
<li><strong>配置 SSL 证书</strong>：使用 Let’s Encrypt 为 Nginx 配置 SSL，确保安全通信。</li>
<li><strong>优化与安全</strong>：配置数据持久化、环境变量管理、网络安全等。</li>
<li><strong>部署与测试</strong>：通过 Docker Compose 部署所有服务，验证应用功能。</li>
<li><strong>开发环境优化</strong>：通过 Docker Compose 配置开发环境，实现实时代码更新和热重载。</li>
</ol>
<p>通过上述步骤，你可以利用 Docker 技术高效、稳定地在 CentOS 服务器上部署与管理你的 Nuxt + Vue3 前端、NestJS 后端和 MongoDB 数据库项目。如有进一步问题，欢迎随时提问！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/09/24/%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2docker%E7%AF%87/" data-id="cm1m7dnhm0009g0u61and57zz" data-title="项目部署docker篇" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/centos/" rel="tag">centos</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/deploy/" rel="tag">deploy</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/" rel="tag">docker</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2024/09/24/%E5%85%B3%E4%BA%8EPromise/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          关于Promise
        
      </div>
    </a>
  
  
    <a href="/2024/09/24/%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">项目部署</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%B1%BB%E5%88%AB/">类别</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Promise/" rel="tag">Promise</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/centos/" rel="tag">centos</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/deploy/" rel="tag">deploy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/" rel="tag">github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/open-source/" rel="tag">open source</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/" rel="tag">反向代理</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/JavaScript/" style="font-size: 10px;">JavaScript</a> <a href="/tags/Promise/" style="font-size: 10px;">Promise</a> <a href="/tags/centos/" style="font-size: 20px;">centos</a> <a href="/tags/deploy/" style="font-size: 20px;">deploy</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/github/" style="font-size: 20px;">github</a> <a href="/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/tags/open-source/" style="font-size: 20px;">open source</a> <a href="/tags/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/" style="font-size: 10px;">反向代理</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">September 2024</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/09/26/nginx%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%AD%A6%E4%B9%A0/">test</a>
          </li>
        
          <li>
            <a href="/2024/09/24/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2024/09/24/%E5%85%B3%E4%BA%8EPromise/">关于Promise</a>
          </li>
        
          <li>
            <a href="/2024/09/24/%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2docker%E7%AF%87/">项目部署docker篇</a>
          </li>
        
          <li>
            <a href="/2024/09/24/%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2/">项目部署</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>